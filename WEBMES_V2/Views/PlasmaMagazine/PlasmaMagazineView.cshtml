
<div class="card ATEC-theme-color mb-3">
       <div class="card-header text-white">
               <H3>PLASMA</H3>
       </div>
   </div>
   
   
   
   <div class="card pb-3">
       <div class="card-body">
        @* Validation *@
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="mb-3">
                <div class="alert alert-danger">
                    <ul>
                        @foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                        {
                            <li>@modelError.ErrorMessage</li>
                        }
                    </ul>
                </div>
            </div>
        }

         <div class="row p-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label>Stage</label>
                    <select id="LastActionPlanSelect" class="select2">
                        <option value="6">DA TO DA CURE</option>
                        <option value="7">PLASMA TO WIREBOND</option>
                        <option value="7">PLASMA TO MOLD</option>
                    </select>
                </div>
            </div>
         </div>

           <div class="row p-3">
               <div class="col-md-4">
                   <label for="txtLotCode" class="form-label">Lot Code</label>
                    <input type="text" class="form-control" id="txtLotCode" value="DUMMYLOT.1-A">
               </div>
            <div class="col-md-4">
                <label for="txtLotQTY" class="form-label">Lot QTY</label>
                <input type="text" class="form-control" id="txtLotQTY">
            </div>
            <div class="col-md-4">
                <label for="txtMachineCode" class="form-label">Machine Code</label>
                <input type="text" class="form-control" id="txtMachineCode" value="TPTA001">
            </div>
           </div>

          @* Table *@
            <div class="p-3" id="magazineTableList"></div>

       </div>
   </div>

@section Scripts 
 
{

    <script>
        //initialize select
        $('.select2').select2({
            width: '100%'
        });

        $(function () {
            $('#txtLotCode').focus();
            $('#txtMachineCode').prop('disabled', true)
            $('#txtLotQTY').prop('disabled', true)

            $('#txtMachineCode').keypress(function (event) {
                if ((event.which >= 65 && event.which <= 90) || (event.which >= 97 && event.which <= 122)) {
                    event.preventDefault();
                }
            });

        });

        //When user hit enter or barcode scanner
        $('#txtLotCode').keypress(function (event) { 
            var selectedStage = $('#LastActionPlanSelect').val();
            var lotAlias = $('#txtLotCode').val();

            if (event.keyCode === 13) {
                callLotChecker(lotAlias,
                              selectedStage)
            }
        });


        //When user hit enter or barcode scanner
        $('#txtMachineCode').keypress(function (event) {
            var machineCode = $('#txtMachineCode').val();
            var lotAlias =  $('#txtLotCode').val();
            var lotQTY = $('#txtLotQTY').val();

            if (event.keyCode === 13) {
                callMachineChecker(lotAlias,
                                   lotQTY, 
                                   machineCode)
            }
        });

        //Function for checking Lot for specific stage
        function callLotChecker(paramLotAlias,
                                paramSelectedStage) {
            return new Promise(function (resolve, reject) {
                $.ajax({
                    type: "GET",
                    url: "/PlasmaMagazine/WhatAction",
                    data: {
                        LotAlias: paramLotAlias,
                        StageCode: paramSelectedStage
                    },
                    dataType: "json",
                    success: function (response) {
                        if (response.status !== 1) {
                            alert(response.message); 
                            return;
                        }

                        var lotQTY = response.details.qty;
                        $('#txtLotQTY').val(lotQTY)


                        $('#txtLotCode').prop('disabled', true);
                        $('#txtMachineCode').prop('disabled', false);
                        $('#txtMachineCode').focus();
              
                    },
                    error: function (xhr, status, error) {
                        alert("AJAX error: " + error);
                    }
                });
            });
        }

        //Function for checking Maachine if existing in PS_Equipment table
        function callMachineChecker(paramLot,
                                    paramLotQTY,
                                    paramMachineCode) {
            $.ajax({
                type: "GET",
                url: "/PlasmaMagazine/CheckMachine",
                data: {
                    MachineCode: paramMachineCode,
                    lotQTY: paramLotQTY,
                    LotAlias : paramLot,
                },
                dataType: "json",
                success: function (response) {
                    if (response.status !== 1) {
                        alert(response.message)
                        return;
                    }
                    //if machine code is exist 
                    $('#txtMachineCode').prop('disabled', true)
                    //Callback
                    callMachineList(response.id,
                                    response.statusRemarks);

                },
                error: function (xhr, status, error) {
                    alert("error")
                    // callErrorPage('An error occurred while fetching data');
                }
            });
        }


        function callMachineList(paramId,
                                 paramStatusRemarks) {
            showSkeletonLoading('magazineTableList', 10, 20)
            $.ajax({
                type: "GET",
                url: "/PlasmaMagazine/_MagazineTrackInList",
                data: {
                    id : paramId
                },
                dataType: "html",
                success: function (response) {

                    $("#magazineTableList").html('');
                    $("#magazineTableList").html(response);
                    $('#txtMagazineCode').focus();


                    //Callback for magazine functionalty
                    $('#txtMagazineCode').keypress(function (event) {
                        var magazineCode = $('#txtMagazineCode').val();
                        var selectedStage = $('#LastActionPlanSelect').val();
                        var remarksMagazine = $('#txtMagazineRemarks').val();

                        if (event.keyCode === 13) {
                            //Callback to validate the magazine
                            callValidateAndInsertMagazine(magazineCode, 
                                                          paramId, 
                                                          paramStatusRemarks,
                                                          selectedStage,
                                                          remarksMagazine);
                        }
                    });      
                },
                error: function (xhr, status, error) {
                    alert("error")
                    // callErrorPage('An error occurred while fetching data');
                }
            });
        }


        function callValidateAndInsertMagazine(magazine, 
                                               paramId,
                                               paramStatusRemarks, 
                                               paramselectedStage,
                                               paramRemarks) {
            
            $.ajax({
                type: "GET",
                url: "/PlasmaMagazine/ValidateandInsertMagazine",
                data: {
                    id: paramId,
                    MagazineCode: magazine,
                    StatusRemarks: paramStatusRemarks,
                    StageCode: paramselectedStage,
                    Remarks: paramRemarks
                },
                dataType: "json",
                success: function (response) {

                    alert(response.message)

   
                },
                error: function (xhr, status, error) {
                    alert("error")
                    // callErrorPage('An error occurred while fetching data');
                }
            });
        }




    </script>

}
